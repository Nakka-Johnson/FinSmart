# Caddy reverse proxy configuration for FinSmart
# Provides automatic HTTPS with Let's Encrypt

{
  # Admin API disabled for security
  admin off
  
  # Email for Let's Encrypt notifications
  email your-email@example.com
}

# HTTP -> HTTPS redirect
:80 {
  redir https://{host}{uri} permanent
}

# Main HTTPS configuration
:443 {
  # Compression
  encode gzip zstd

  # Automatic TLS with Let's Encrypt
  tls {
    on_demand
  }

  # Security headers
  header {
    # Prevent clickjacking
    X-Frame-Options "DENY"
    
    # Prevent MIME-type sniffing
    X-Content-Type-Options "nosniff"
    
    # Enable XSS protection
    X-XSS-Protection "1; mode=block"
    
    # Referrer policy
    Referrer-Policy "no-referrer"
    
    # Content Security Policy
    Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;"
    
    # Remove server header
    -Server
  }

  # Backend API routes
  handle_path /api/* {
    reverse_proxy backend:8080 {
      # Health check
      health_uri /api/health
      health_interval 10s
      health_timeout 5s
      
      # Timeouts
      transport http {
        dial_timeout 5s
        response_header_timeout 30s
      }
    }
  }

  # AI service routes (optional if backend proxies these)
  handle_path /ai/* {
    reverse_proxy ai:8001 {
      health_uri /health
      health_interval 10s
    }
  }

  # Actuator endpoints (secured by backend)
  handle_path /actuator/* {
    reverse_proxy backend:8080
  }

  # Frontend SPA (catch-all)
  handle {
    reverse_proxy frontend:80 {
      health_uri /health
      health_interval 10s
    }
  }

  # Access logging (optional)
  log {
    output file /var/log/caddy/access.log
    format json
  }
}

# Development/staging configuration (HTTP only, no TLS)
# Uncomment for initial testing without a domain
# :80 {
#   encode gzip zstd
#   
#   handle_path /api/* {
#     reverse_proxy backend:8080
#   }
#   
#   handle {
#     reverse_proxy frontend:80
#   }
# }
